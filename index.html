<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Registrars</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Babel (pour JSX dans app.js) -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <script>
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = false; // garde l'ordre
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    async function loadWithFallback(primary, fallback, label) {
      try {
        await loadScript(primary);
        console.log(`[OK] ${label} (primary)`);
      } catch (e) {
        console.warn(`[WARN] ${label} primary failed -> fallback`);
        await loadScript(fallback);
        console.log(`[OK] ${label} (fallback)`);
      }
    }

    async function loadAndRunAppJsx(appUrl) {
      const res = await fetch(appUrl, { cache: "no-store" });
      if (!res.ok) throw new Error(`Impossible de charger ${appUrl} (${res.status})`);
      const source = await res.text();

      const compiled = Babel.transform(source, {
        presets: ["react"]
      }).code;

      // Exécute le code compilé dans le contexte global
      (0, eval)(compiled);
    }

    (async () => {
      // React + ReactDOM (fallback CDN)
      await loadWithFallback(
        "https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js",
        "https://unpkg.com/react@18/umd/react.development.js",
        "React"
      );

      await loadWithFallback(
        "https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js",
        "https://unpkg.com/react-dom@18/umd/react-dom.development.js",
        "ReactDOM"
      );

      // Dépendances Recharts
      await loadWithFallback(
        "https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js",
        "https://unpkg.com/prop-types@15.8.1/prop-types.min.js",
        "PropTypes"
      );

      await loadWithFallback(
        "https://cdn.jsdelivr.net/npm/react-is@18/umd/react-is.development.js",
        "https://unpkg.com/react-is@18/umd/react-is.development.js",
        "react-is"
      );

      // Recharts
      await loadWithFallback(
        "https://cdn.jsdelivr.net/npm/recharts@2.4.3/umd/Recharts.min.js",
        "https://unpkg.com/recharts@2.4.3/umd/Recharts.min.js",
        "Recharts"
      );

      // Lance app.js (JSX) via Babel
      await loadAndRunAppJsx("app.js");
    })().catch((err) => {
      console.error(err);
      document.getElementById("root").innerHTML =
        '<div style="padding:16px;font-family:system-ui;">Erreur au chargement. Ouvre la console (F12) pour voir le détail.</div>';
    });
  </script>
</head>

<body class="bg-gray-100">
  <div id="root"></div>
</body>
</html>
